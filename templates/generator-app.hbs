<div class="vibe-scene-two-app">
    <div class="vibe-stepper">
        <div class="step {{#if (eq step 1)}}active{{/if}}">1. Concept</div>
        <div class="step {{#if (eq step 2)}}active{{/if}}">2. Outline & Layout</div>
        <div class="step {{#if (eq step 3)}}active{{/if}}">3. Final Review</div>
    </div>

    <hr>

    <div class="step-content">
        {{#if (eq step 1)}}
        <div class="form-group stacked">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="margin: 0;">What kind of scene do you want to generate?</label>
                <button type="button" data-action="randomize" title="Random scene concept"
                    style="padding: 2px 8px; font-size: 0.85em; cursor: pointer;"><i class="fas fa-dice"></i></button>
            </div>
            <p class="notes">Describe the biome, interior/exterior, specific rooms, and overall vibe. E.g., "A cozy
                interior of a fantasy tavern named The Prancing Pony, including a common room, kitchen, and cellar."</p>
            <textarea name="userPrompt" rows="6">{{userPrompt}}</textarea>
        </div>
        <div class="form-group checkbox-group" style="margin-top: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                <input type="checkbox" name="includeRoomLabels" {{#if includeRoomLabels}}checked{{/if}}>
                Draw room names directly on the map image
            </label>
            <p class="notes" style="margin-left: 24px;">If unchecked, room names will only appear as clickable Journals.
            </p>
        </div>

        {{/if}}

        {{#if (eq step 2)}}
        {{#unless isGenerating}}
        <div class="svg-preview"
            style="margin-top: 10px; background: #222; padding: 10px; text-align: center; border-radius: 5px; border: 1px solid #444; flex-grow: 1; display: flex; flex-direction: column;">
            <h3>SVG Layout Preview</h3>
            <div id="svg-container"
                style="height: 60vh; overflow: hidden; display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
                {{{svg}}}
            </div>
            <p class="notes" style="margin-top: auto;">This abstract layout will guide the image generation.</p>
        </div>
        <div class="form-group checkbox-group" style="margin-top: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                <input type="checkbox" name="useInpaintingPipeline" {{#if useInpaintingPipeline}}checked{{/if}}>
                Experimental: Use Inpainting Pipeline (Room-by-Room generation)
            </label>
            <p class="notes" style="margin-left: 24px;">Uses individual room SVG masks to guide the composition.</p>
        </div>
        {{/unless}}
        {{/if}}

        {{#if (eq step 3)}}
        {{#unless isGenerating}}
        <div class="image-review" style="text-align: center; display: flex; flex-direction: column;">
            <h3>Final Rendered Map</h3>
            <img src="data:image/jpeg;base64,{{imageBuffer}}"
                style="max-width: 100%; height: 60vh; object-fit: contain; border-radius: 5px; border: 1px solid #444; box-shadow: 0 4px 8px rgba(0,0,0,0.5); margin-bottom: 15px;">
            <p class="notes" style="margin-top: auto;">If approved, this will be imported as a Scene with walls and
                lighting.</p>
        </div>
        {{/unless}}
        {{/if}}
    </div>

    <footer class="sheet-footer flexrow" style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
        {{#if (gt step 1)}}
        <button type="button" data-action="back"><i class="fas fa-arrow-left"></i> Back</button>
        {{/if}}

        {{#if (eq step 1)}}
        <button type="button" data-action="next"><i class="fas fa-magic"></i> Generate Layout</button>
        {{/if}}

        {{#if (eq step 2)}}
        <button type="button" data-action="next"><i class="fas fa-image"></i> Render Map</button>
        {{/if}}

        {{#if (eq step 3)}}
        <button type="button" data-action="finish"><i class="fas fa-check"></i> Create Scene</button>
        {{/if}}
    </footer>
</div>